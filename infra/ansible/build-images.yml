---
# Build and Distribute Docker Images for K3s Cluster
# This playbook automates the build-export-import cycle for local development
# MODIFIED: Environment-agnostic implementation supporting both Vagrant and GitLab CI

# 1. BUILD: Build Server Image on Control Plane
- name: Build Server Image on Control Plane
  hosts: k3s_control
  become: true
  vars:
    # MODIFIED: Use consistent paths that work in both Vagrant and GitLab CI
    server_build_path: /tmp/server-build
    server_image_tar: /tmp/server-image.tar
    server_source_path: "{{ playbook_dir }}/../../server"
  tasks:
    - name: Ensure Docker is installed
      package:
        name: docker.io
        state: present

    # MODIFIED: Verify server source path exists
    - name: Check if server source directory exists
      stat:
        path: "{{ server_source_path }}"
      register: server_source_stat
      delegate_to: localhost
      run_once: true

    # MODIFIED: Fail if server directory not found
    - name: Fail if server directory not found
      fail:
        msg: "Server source directory not found at {{ server_source_path }}. Playbook dir: {{ playbook_dir }}"
      when: not server_source_stat.stat.exists
      delegate_to: localhost
      run_once: true

    # MODIFIED: Copy server directory to control plane (works in both Vagrant and GitLab CI)
    # Ansible copy module resolves paths relative to playbook_dir automatically
    - name: Copy server source to control plane
      copy:
        src: "{{ server_source_path }}/"
        dest: "{{ server_build_path }}"
        exclude:
          - "node_modules"
          - ".git"
          - "*.log"
        mode: preserve

    # MODIFIED: Build Docker image from copied source
    - name: Build Docker image from source
      command: docker build -t server:latest {{ server_build_path }}
      args:
        chdir: "{{ server_build_path }}"

    # MODIFIED: Save Docker image to tarball
    - name: Save Docker image to tarball
      command: docker save server:latest -o {{ server_image_tar }}

# 2. DISTRIBUTE: Import Image on All Nodes
- name: Import Image on All Nodes
  hosts: k3s_nodes
  become: true
  vars:
    server_image_tar: /tmp/server-image.tar
  serial: 1 # Run one at a time to avoid disk I/O contention
  tasks:
    # MODIFIED: Copy tarball from control plane to each worker node
    - name: Copy image tarball to worker node
      copy:
        src: "{{ server_image_tar }}"
        dest: "{{ server_image_tar }}"
        remote_src: true
      delegate_to: "{{ groups['k3s_control'][0] }}"
      when: inventory_hostname in groups['k3s_workers']

    # MODIFIED: Import image into K3s (containerd)
    - name: Import image into K3s (containerd)
      command: k3s ctr images import {{ server_image_tar }}
      register: import_result
      changed_when: "'unpacking' in import_result.stdout"

# 3. CLEANUP: Remove staged code and artifacts
- name: Cleanup Staged Code and Artifacts
  hosts: k3s_nodes
  become: true
  vars:
    server_build_path: /tmp/server-build
    server_image_tar: /tmp/server-image.tar
  tasks:
    # MODIFIED: Remove build directory (only on control plane)
    - name: Remove build directory
      file:
        path: "{{ server_build_path }}"
        state: absent
      when: inventory_hostname in groups['k3s_control']

    # MODIFIED: Remove image tarball from all nodes
    - name: Remove image tarball
      file:
        path: "{{ server_image_tar }}"
        state: absent
