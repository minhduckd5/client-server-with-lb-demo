---
# Build and Distribute Docker Images for K3s Cluster
# This playbook automates the build-export-import cycle for local development

# 1. STAGE: Copy source code to shared folder (Localhost)
- name: Stage Server Source Code
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Sync server directory
      shell: |
        mkdir -p "{{ playbook_dir }}/../vagrant/server"
        if command -v rsync >/dev/null 2>&1; then
          # Use rsync for efficiency if available
          rsync -av --delete --exclude='node_modules' --exclude='.git' "{{ playbook_dir }}/../../server/" "{{ playbook_dir }}/../vagrant/server/"
        else
          # Fallback for environments without rsync (e.g. Alpine default)
          cp -R "{{ playbook_dir }}/../../server/." "{{ playbook_dir }}/../vagrant/server/"
          # Manual cleanup of excluded items
          rm -rf "{{ playbook_dir }}/../vagrant/server/node_modules"
          rm -rf "{{ playbook_dir }}/../vagrant/server/.git"
        fi
      args:
        executable: /bin/sh

# 2. BUILD: Build Server Image on Control Plane
- name: Build Server Image on Control Plane
  hosts: k3s_control
  become: true
  tasks:
    - name: Ensure Docker is installed
      package:
        name: docker.io
        state: present

    - name: Build Docker image from source
      command: docker build -t server:latest /vagrant/server
      args:
        chdir: /vagrant/server

    - name: Save Docker image to tarball
      command: docker save server:latest -o /vagrant/server-image.tar

# 3. DISTRIBUTE: Import Image on All Nodes
- name: Import Image on All Nodes
  hosts: k3s_nodes
  become: true
  serial: 1 # Run one at a time to avoid disk I/O contention
  tasks:
    - name: Import image into K3s (containerd)
      command: k3s ctr images import /vagrant/server-image.tar
      register: import_result
      changed_when: "'unpacking' in import_result.stdout"

# 4. CLEANUP: Remove staged code (Localhost)
- name: Cleanup Staged Code
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Remove staged server directory
      file:
        path: "{{ playbook_dir }}/../vagrant/server"
        state: absent
