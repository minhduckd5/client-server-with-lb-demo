---
# Deploy Ingress Controller (Nginx)
# This playbook deploys Nginx Ingress Controller exposed via MetalLB

- name: Deploy Nginx Ingress Controller
  hosts: k3s_control
  become: true
  gather_facts: true

  vars:
    kubeconfig_path: "/home/{{ ansible_user }}/.kube/config"
    ingress_namespace: "ingress-nginx"

  tasks:
    - name: Check if Ingress Controller is already installed
      shell: kubectl --kubeconfig={{ kubeconfig_path }} get namespace {{ ingress_namespace }}
      register: ingress_check
      ignore_errors: true
      changed_when: false

    - name: Create Ingress Controller manifest with MetalLB
      template:
        src: nginx-ingress-metallb.yaml.j2
        dest: /tmp/nginx-ingress.yaml
        mode: '0644'

    - name: Apply Ingress Controller manifest
      shell: kubectl --kubeconfig={{ kubeconfig_path }} apply -f /tmp/nginx-ingress.yaml
      when: ingress_check.rc != 0
      register: ingress_apply

    - name: Wait for Ingress Controller deployment rollout (max 60s)
      shell: kubectl --kubeconfig={{ kubeconfig_path }} rollout status deployment/ingress-nginx-controller -n {{ ingress_namespace }} --timeout=60s
      register: ingress_wait
      ignore_errors: true

    - name: Get Ingress Controller pod status on rollout failure
      shell: kubectl --kubeconfig={{ kubeconfig_path }} get pods -n {{ ingress_namespace }} -o wide
      when: ingress_wait.rc is defined and ingress_wait.rc != 0
      register: ingress_pods_status
      ignore_errors: true

    - name: Debug Ingress Controller pod status on rollout failure
      debug:
        var: ingress_pods_status.stdout_lines
      when: ingress_wait.rc is defined and ingress_wait.rc != 0

    - name: Get Ingress Controller pod logs on rollout failure
      shell: kubectl --kubeconfig={{ kubeconfig_path }} logs -n {{ ingress_namespace }} -l app.kubernetes.io/component=controller --tail=100
      when: ingress_wait.rc is defined and ingress_wait.rc != 0
      register: ingress_pods_logs
      ignore_errors: true

    - name: Debug Ingress Controller pod logs on rollout failure
      debug:
        var: ingress_pods_logs.stdout_lines
      when: ingress_wait.rc is defined and ingress_wait.rc != 0

    # MODIFIED: extra deep-dive diagnostics for non-ready Ingress Controller
    - name: Check ingress-nginx admission secret existence on rollout failure
      shell: kubectl --kubeconfig={{ kubeconfig_path }} get secret ingress-nginx-admission -n {{ ingress_namespace }} -o yaml
      when: ingress_wait.rc is defined and ingress_wait.rc != 0
      register: ingress_admission_secret
      ignore_errors: true

    - name: Debug ingress-nginx admission secret (or missing state)
      debug:
        var: ingress_admission_secret.stdout_lines
      when: ingress_wait.rc is defined and ingress_wait.rc != 0

    - name: Describe Ingress Controller deployment on rollout failure
      shell: kubectl --kubeconfig={{ kubeconfig_path }} describe deployment ingress-nginx-controller -n {{ ingress_namespace }}
      when: ingress_wait.rc is defined and ingress_wait.rc != 0
      register: ingress_deploy_describe
      ignore_errors: true

    - name: Debug Ingress Controller deployment description
      debug:
        var: ingress_deploy_describe.stdout_lines
      when: ingress_wait.rc is defined and ingress_wait.rc != 0

    - name: Get recent events for ingress-nginx namespace on rollout failure
      shell: kubectl --kubeconfig={{ kubeconfig_path }} get events -n {{ ingress_namespace }} --sort-by=.lastTimestamp | tail -n 25
      when: ingress_wait.rc is defined and ingress_wait.rc != 0
      register: ingress_events
      ignore_errors: true

    - name: Debug recent ingress-nginx events
      debug:
        var: ingress_events.stdout_lines
      when: ingress_wait.rc is defined and ingress_wait.rc != 0

    - name: Describe Ingress Controller pods if rollout failed
      shell: kubectl --kubeconfig={{ kubeconfig_path }} describe pods -n {{ ingress_namespace }} -l app.kubernetes.io/component=controller
      when: ingress_wait.rc is defined and ingress_wait.rc != 0
      register: ingress_pods_describe
      ignore_errors: true

    - name: Debug Ingress Controller pod description
      debug:
        var: ingress_pods_describe.stdout_lines
      when: ingress_wait.rc is defined and ingress_wait.rc != 0

    - name: Get Ingress Controller LoadBalancer IP
      shell: kubectl --kubeconfig={{ kubeconfig_path }} get svc -n {{ ingress_namespace }} ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
      register: ingress_ip
      changed_when: false
      until: ingress_ip.stdout != ""
      retries: 30
      delay: 5

    - name: Display Ingress Controller IP
      debug:
        msg: "Ingress Controller LoadBalancer IP: {{ ingress_ip.stdout }}"

