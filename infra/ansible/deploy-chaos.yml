---
# Deploy Chaos Engineering Stack to Monitoring VM
# This playbook syncs the chaos directory and installs dependencies

# 1. STAGE: Copy chaos configuration to shared folder (Localhost)
- name: Stage Chaos Configuration
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Sync chaos directory
      shell: |
        mkdir -p "{{ playbook_dir }}/../vagrant/chaos"
        if command -v rsync >/dev/null 2>&1; then
          # Use rsync for efficiency if available
          rsync -av --delete --exclude='.git' --exclude='__pycache__' "{{ playbook_dir }}/../../chaos/" "{{ playbook_dir }}/../vagrant/chaos/"
        else
          # Fallback for environments without rsync
          cp -R "{{ playbook_dir }}/../../chaos/." "{{ playbook_dir }}/../vagrant/chaos/"
        fi
      args:
        executable: /bin/sh

# 2. DEPLOY: Setup Chaos Toolkit on Monitoring Node
- name: Deploy Chaos Toolkit
  hosts: monitoring
  become: true
  tasks:
    - name: Ensure Python3 and pip are installed
      apt:
        name:
          - python3
          - python3-pip
          - python3-venv
          - stress-ng
          - build-essential
          - python3-dev
          - libffi-dev
          - libssl-dev
        state: present
        update_cache: true

    - name: Create working directory
      file:
        path: /home/vagrant/chaos
        state: directory
        owner: vagrant
        group: vagrant
        mode: '0755'

    - name: Copy chaos files from shared folder
      # Copy from /vagrant (shared) to /home/vagrant (workspace)
      # remote_src=yes means copy from remote machine (VM) filesystem
      copy:
        src: /vagrant/chaos/
        dest: /home/vagrant/chaos/
        remote_src: yes
        owner: vagrant
        group: vagrant
        mode: '0755'

    - name: Install Chaos Toolkit dependencies
      pip:
        requirements: /home/vagrant/chaos/chaos-toolkit/requirements.txt
        # Install globally or in a venv? Global is easier for single-purpose VM
        executable: pip3
        extra_args: --break-system-packages

    - name: Fix permissions
      file:
        path: /home/vagrant/chaos
        owner: vagrant
        group: vagrant
        recurse: yes

# 3. CLEANUP: Remove staged code (Localhost)
- name: Cleanup Staged Code
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Remove staged chaos directory
      file:
        path: "{{ playbook_dir }}/../vagrant/chaos"
        state: absent

