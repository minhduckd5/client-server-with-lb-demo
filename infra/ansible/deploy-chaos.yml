---
# Deploy Chaos Engineering Stack to Monitoring VM
# This playbook syncs the chaos directory directly from controller to target

- name: Deploy Chaos Toolkit
  hosts: monitoring
  become: true
  tasks:
    - name: Ensure Python3 and pip are installed
      apt:
        name:
          - python3
          - python3-pip
          - python3-venv
          - stress-ng
          - build-essential
          - python3-dev
          - libffi-dev
          - libssl-dev
        state: present
        update_cache: true

    - name: Create working directory
      file:
        path: /home/vagrant/chaos
        state: directory
        owner: vagrant
        group: vagrant
        mode: '0755'

    - name: Copy chaos files from controller
      # Direct copy from Ansible controller to Target
      # Avoids /vagrant shared folder issues
      copy:
        src: "{{ playbook_dir }}/../../chaos/"
        dest: /home/vagrant/chaos/
        owner: vagrant
        group: vagrant
        mode: '0755'
        # exclude git and cache files
        local_follow: yes

    - name: Copy SSH private key for inter-node access
      copy:
        src: ~/.ssh/insecure_private_key
        dest: /home/vagrant/.ssh/insecure_private_key
        owner: vagrant
        group: vagrant
        mode: '0600'

    - name: Install Chaos Toolkit dependencies
      pip:
        requirements: /home/vagrant/chaos/chaos-toolkit/requirements.txt
        executable: pip3
        extra_args: --break-system-packages

    - name: Set PYTHONPATH for custom modules
      lineinfile:
        path: /home/vagrant/.bashrc
        line: 'export PYTHONPATH=$PYTHONPATH:/home/vagrant/chaos/chaos-toolkit'
        state: present

    - name: Fix permissions
      file:
        path: /home/vagrant/chaos
        owner: vagrant
        group: vagrant
        recurse: yes
